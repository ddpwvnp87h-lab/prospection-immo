{% extends "base.html" %}

{% block title %}Dashboard - Prospection Immo{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>Mes Annonces</h2>
        <div class="header-actions">
            <a href="{{ url_for('scrape_page') }}" class="btn btn-primary">+ Nouveau scraping</a>
            {% if stats.total > 0 %}
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAll()">üóëÔ∏è Tout supprimer</button>
            {% endif %}
        </div>
    </div>

    <!-- Modal de confirmation suppression totale -->
    <div id="delete-all-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Supprimer toutes les annonces ?</h3>
            <p>Cette action va supprimer <strong>{{ stats.total }} annonces</strong>. Cette action est irr√©versible.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="closeModal()">Annuler</button>
                <form method="POST" action="{{ url_for('delete_all_listings') }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Confirmer la suppression</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat-card stat-nouveau">
            <div class="stat-value">{{ stats.nouveau }}</div>
            <div class="stat-label">Nouveau</div>
        </div>
        <div class="stat-card stat-interesse">
            <div class="stat-value">{{ stats.interesse }}</div>
            <div class="stat-label">Int√©ress√©</div>
        </div>
        <div class="stat-card stat-visite">
            <div class="stat-value">{{ stats.visite }}</div>
            <div class="stat-label">Visit√©</div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters">
        <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
            <div class="filter-group">
                <input type="text" name="search" placeholder="Rechercher..." value="{{ search_query }}" class="filter-input">
            </div>

            <div class="filter-group">
                <select name="status" class="filter-select">
                    <option value="">Tous les statuts</option>
                    <option value="Nouveau" {% if current_status == 'Nouveau' %}selected{% endif %}>Nouveau</option>
                    <option value="Int√©ress√©" {% if current_status == 'Int√©ress√©' %}selected{% endif %}>Int√©ress√©</option>
                    <option value="Pas int√©ress√©" {% if current_status == 'Pas int√©ress√©' %}selected{% endif %}>Pas int√©ress√©</option>
                    <option value="Visit√©" {% if current_status == 'Visit√©' %}selected{% endif %}>Visit√©</option>
                    <option value="Contact pris" {% if current_status == 'Contact pris' %}selected{% endif %}>Contact pris</option>
                    <option value="Offre faite" {% if current_status == 'Offre faite' %}selected{% endif %}>Offre faite</option>
                </select>
            </div>

            <div class="filter-group">
                <select name="sort" class="filter-select">
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Date d'ajout</option>
                    <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Prix</option>
                    <option value="published_date" {% if sort_by == 'published_date' %}selected{% endif %}>Date de publication</option>
                </select>
            </div>

            <div class="filter-group">
                <select name="order" class="filter-select">
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>D√©croissant</option>
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Croissant</option>
                </select>
            </div>

            <button type="submit" class="btn btn-secondary">Filtrer</button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline">R√©initialiser</a>
        </form>
    </div>

    <!-- Liste des annonces -->
    <div class="listings-grid">
        {% if listings %}
            {% for listing in listings %}
            <div class="listing-card" data-status="{{ listing.status }}">
                <div class="listing-image">
                    {% if listing.photos and listing.photos|length > 0 %}
                        <img src="{{ listing.photos[0] }}" alt="{{ listing.title }}" loading="lazy">
                    {% else %}
                        <div class="listing-no-image">üì∑</div>
                    {% endif %}
                    <span class="listing-badge listing-badge-{{ listing.status|lower|replace(' ', '-') }}">
                        {{ listing.status }}
                    </span>
                </div>

                <div class="listing-content">
                    <h3 class="listing-title">
                        <a href="{{ url_for('view_listing', listing_id=listing.id) }}">
                            {{ listing.title }}
                        </a>
                    </h3>

                    <div class="listing-meta">
                        <span class="listing-price">{{ "{:,}".format(listing.price).replace(',', ' ') }} ‚Ç¨</span>
                        <span class="listing-location">üìç {{ listing.location }}</span>
                    </div>

                    {% if listing.surface or listing.rooms %}
                    <div class="listing-details">
                        {% if listing.surface %}
                            <span>{{ listing.surface }} m¬≤</span>
                        {% endif %}
                        {% if listing.rooms %}
                            <span>{{ listing.rooms }} pi√®ces</span>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="listing-footer">
                        <span class="listing-source">{{ listing.source }}</span>
                        <span class="listing-date">{{ listing.published_date or 'Date inconnue' }}</span>
                    </div>

                    <div class="listing-actions">
                        <form method="POST" action="{{ url_for('update_status', listing_id=listing.id) }}" class="status-form">
                            <select name="status" onchange="this.form.submit()" class="status-select">
                                <option value="Nouveau" {% if listing.status == 'Nouveau' %}selected{% endif %}>Nouveau</option>
                                <option value="Int√©ress√©" {% if listing.status == 'Int√©ress√©' %}selected{% endif %}>‚úì Int√©ress√©</option>
                                <option value="Pas int√©ress√©" {% if listing.status == 'Pas int√©ress√©' %}selected{% endif %}>‚úó Pas int√©ress√©</option>
                                <option value="Visit√©" {% if listing.status == 'Visit√©' %}selected{% endif %}>üëÅ Visit√©</option>
                                <option value="Contact pris" {% if listing.status == 'Contact pris' %}selected{% endif %}>üìû Contact pris</option>
                                <option value="Offre faite" {% if listing.status == 'Offre faite' %}selected{% endif %}>üí∞ Offre faite</option>
                            </select>
                        </form>

                        <a href="{{ listing.url }}" target="_blank" class="btn btn-sm btn-outline">Voir l'annonce</a>

                        <form method="POST" action="{{ url_for('delete_listing', listing_id=listing.id) }}" class="delete-form" onsubmit="return confirm('Supprimer cette annonce ?')">
                            <button type="submit" class="btn btn-sm btn-danger-outline" title="Supprimer">üóëÔ∏è</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">üè†</div>
                <h3>Aucune annonce</h3>
                <p>Lancez un scraping pour commencer √† collecter des annonces.</p>
                <a href="{{ url_for('scrape_page') }}" class="btn btn-primary">Lancer un scraping</a>
            </div>
        {% endif %}
    </div>
</div>

<style>
/* Header actions */
.header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-content h3 {
    margin-bottom: 1rem;
    color: var(--danger);
}

.modal-content p {
    margin-bottom: 1.5rem;
    color: var(--gray-600);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

/* Delete button on cards */
.btn-danger-outline {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
}

.btn-danger-outline:hover {
    background: var(--danger);
    color: white;
}

.delete-form {
    display: inline;
}

.listing-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}
</style>

<script>
function confirmDeleteAll() {
    document.getElementById('delete-all-modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('delete-all-modal').style.display = 'none';
}

// Fermer le modal en cliquant en dehors
document.addEventListener('click', function(e) {
    const modal = document.getElementById('delete-all-modal');
    if (e.target === modal) {
        closeModal();
    }
});

// Fermer avec Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
