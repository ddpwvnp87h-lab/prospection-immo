{% extends "base.html" %}

{% block title %}Scraping - Prospection Immo{% endblock %}

{% block content %}
<div class="scrape-page">
    <h2>üîç Lancer un Scraping</h2>

    <!-- Status Panel -->
    <div id="status-panel" class="status-panel {% if scraping_status.running %}status-running{% endif %}">
        <div class="status-header">
            <span id="status-icon">{% if scraping_status.running %}‚è≥{% else %}‚úÖ{% endif %}</span>
            <span id="status-message">{{ scraping_status.message or 'Pr√™t √† scraper' }}</span>
        </div>

        {% if scraping_status.running %}
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: {{ scraping_status.progress }}%"></div>
            </div>
            <span class="progress-text" id="progress-text">{{ scraping_status.progress }}%</span>
        </div>

        <form method="POST" action="{{ url_for('stop_scrape') }}" class="stop-form">
            <button type="submit" class="btn btn-danger">Arr√™ter le scraping</button>
        </form>
        {% endif %}

        {% if scraping_status.results and not scraping_status.running %}
        <div class="results-summary">
            <h4>R√©sultats du dernier scraping:</h4>
            <ul>
                <li>Annonces scrap√©es: <strong>{{ scraping_status.results.total_scraped }}</strong></li>
                <li>Annonces valides: <strong>{{ scraping_status.results.valid }}</strong></li>
                <li>Particuliers uniquement: <strong>{{ scraping_status.results.particuliers }}</strong></li>
                <li>Apr√®s d√©duplication: <strong>{{ scraping_status.results.final }}</strong></li>
            </ul>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Voir les annonces</a>
        </div>
        {% endif %}
    </div>

    <!-- Scraping Form -->
    {% if not scraping_status.running %}
    <div class="scrape-form-container">
        <form method="POST" action="{{ url_for('run_scrape') }}" class="scrape-form" id="scrape-form">
            <div class="form-row">
                <div class="form-group form-group-location">
                    <label for="ville">Ville ou Code Postal</label>
                    <div class="input-with-button">
                        <input type="text" id="ville" name="ville" value="Paris" required placeholder="Paris, 75001, Lyon, 69003...">
                        <button type="button" id="geoloc-btn" class="btn btn-secondary btn-geoloc" title="Utiliser ma position">
                            üìç
                        </button>
                    </div>
                    <small class="form-hint" id="location-hint">Entrez une ville/code postal ou cliquez üìç pour votre position</small>
                    <!-- Champs cach√©s pour les coordonn√©es -->
                    <input type="hidden" id="lat" name="lat" value="">
                    <input type="hidden" id="lon" name="lon" value="">
                </div>

                <div class="form-group">
                    <label for="rayon">Rayon (km)</label>
                    <input type="number" id="rayon" name="rayon" value="10" min="1" max="100" required>
                </div>
            </div>

            <!-- Carte interactive -->
            <div class="form-group map-container">
                <label>Zone de recherche</label>
                <div id="map"></div>
                <small class="form-hint" id="map-hint">La carte montre la zone de recherche</small>
            </div>

            <div class="form-group">
                <label>Sites √† scraper</label>
                <div class="sites-grid">
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="pap" checked>
                        <span class="site-name">pap.fr</span>
                        <span class="site-tag tag-easy">Particuliers</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="entreparticuliers" checked>
                        <span class="site-name">EntreParticuliers</span>
                        <span class="site-tag tag-easy">100% Particuliers</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="paruvendu">
                        <span class="site-name">ParuVendu</span>
                        <span class="site-tag tag-easy">Particuliers</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="figaro">
                        <span class="site-name">Figaro Immo</span>
                        <span class="site-tag tag-easy">Rapide</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="moteurimmo">
                        <span class="site-name">MoteurImmo</span>
                        <span class="site-tag tag-slow">Agr√©gateur</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="leboncoin" checked>
                        <span class="site-name">leboncoin.fr</span>
                        <span class="site-tag tag-warning">Playwright</span>
                    </label>
                    <label class="site-checkbox">
                        <input type="checkbox" name="sites" value="facebook">
                        <span class="site-name">Facebook</span>
                        <span class="site-tag tag-warning">Connexion requise</span>
                    </label>
                </div>
                <small>Tous les sites sont actifs. LeBonCoin utilise Playwright. Facebook peut n√©cessiter une connexion.</small>
            </div>

            <button type="submit" class="btn btn-primary btn-lg btn-block">
                üöÄ Lancer le Scraping
            </button>
        </form>
    </div>
    {% endif %}

    <!-- Info -->
    <div class="info-box info-box-info">
        <h4>Comment √ßa marche?</h4>
        <ol>
            <li>Choisis une ville et un rayon de recherche</li>
            <li>S√©lectionne les sites √† scraper (PAP + EntreParticuliers recommand√©s)</li>
            <li>Clique sur <strong>"Lancer le Scraping"</strong></li>
            <li>Attends que la barre de progression arrive √† 100%</li>
            <li>Les annonces apparaissent automatiquement dans ton Dashboard!</li>
        </ol>
        <p style="margin-top: 1rem; font-size: 0.9rem;"><strong>Sites 100% particuliers:</strong> PAP, EntreParticuliers, ParuVendu (avec filtre)</p>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
.scrape-page h2 {
    margin-bottom: 1.5rem;
}

/* Carte */
.map-container {
    margin-bottom: 1.5rem;
}

#map {
    height: 280px;
    border-radius: var(--radius);
    border: 2px solid var(--gray-200);
    z-index: 1;
}

#map-hint {
    margin-top: 0.5rem;
    display: block;
}

.status-panel {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--success);
}

.status-panel.status-running {
    border-left-color: var(--warning);
    background: #FFFBEB;
}

.status-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
    font-weight: 500;
}

#status-icon {
    font-size: 1.5rem;
}

.progress-container {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.progress-bar {
    flex: 1;
    height: 24px;
    background: #E5E7EB;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    transition: width 0.3s ease;
    border-radius: 12px;
}

.progress-text {
    font-weight: 600;
    font-size: 1.1rem;
    min-width: 50px;
}

.stop-form {
    margin-top: 1rem;
}

.results-summary {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
}

.results-summary h4 {
    margin-bottom: 0.75rem;
    color: var(--success);
}

.results-summary ul {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.results-summary li {
    margin-bottom: 0.25rem;
}

.scrape-form-container {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
}

.form-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.sites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.site-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--gray-50);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: normal;
    border: 2px solid transparent;
}

.site-checkbox:hover {
    background: var(--gray-100);
    border-color: var(--gray-300);
}

.site-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.site-checkbox input[type="checkbox"]:checked + .site-name {
    font-weight: 600;
}

.site-name {
    flex: 1;
}

.site-tag {
    font-size: 0.7rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
}

.tag-easy {
    background: #D1FAE5;
    color: #065F46;
}

.tag-slow {
    background: #FEF3C7;
    color: #92400E;
}

.tag-warning {
    background: #FEE2E2;
    color: #991B1B;
}

.tag-disabled {
    background: #E5E7EB;
    color: #6B7280;
}

.site-disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.site-disabled:hover {
    background: var(--gray-50);
    border-color: transparent;
}

.btn-block {
    width: 100%;
    margin-top: 1.5rem;
    padding: 1rem 2rem;
    font-size: 1.2rem;
}

.info-box {
    padding: 1.5rem;
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--info);
    background: #DBEAFE;
}

.info-box h4 {
    margin-bottom: 0.75rem;
}

.info-box ol {
    padding-left: 1.5rem;
    margin: 0;
}

.info-box li {
    margin-bottom: 0.5rem;
}

@media (max-width: 600px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .sites-grid {
        grid-template-columns: 1fr;
    }
}

/* G√©olocalisation */
.input-with-button {
    display: flex;
    gap: 0.5rem;
}

.input-with-button input {
    flex: 1;
}

.btn-geoloc {
    padding: 0.5rem 0.75rem;
    font-size: 1.2rem;
    min-width: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-geoloc:hover {
    transform: scale(1.05);
}

.btn-geoloc.loading {
    animation: pulse 1s infinite;
}

.btn-geoloc.success {
    background: var(--success);
    color: white;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.location-detected {
    color: var(--success);
    font-weight: 500;
}
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Script Carte + G√©olocalisation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const geolocBtn = document.getElementById('geoloc-btn');
    const villeInput = document.getElementById('ville');
    const latInput = document.getElementById('lat');
    const lonInput = document.getElementById('lon');
    const locationHint = document.getElementById('location-hint');
    const rayonInput = document.getElementById('rayon');
    const mapHint = document.getElementById('map-hint');

    // Initialiser la carte (Paris par d√©faut)
    let map = L.map('map').setView([48.8566, 2.3522], 10);
    let searchCircle = null;
    let marker = null;

    // Ajouter le fond de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Fonction pour mettre √† jour le cercle de recherche
    function updateSearchCircle(lat, lon, rayonKm) {
        // Supprimer l'ancien cercle et marker
        if (searchCircle) map.removeLayer(searchCircle);
        if (marker) map.removeLayer(marker);

        // Cr√©er le nouveau cercle
        searchCircle = L.circle([lat, lon], {
            color: '#4F46E5',
            fillColor: '#4F46E5',
            fillOpacity: 0.15,
            radius: rayonKm * 1000, // Convertir km en m√®tres
            weight: 2
        }).addTo(map);

        // Ajouter un marker au centre
        marker = L.marker([lat, lon]).addTo(map);

        // Ajuster la vue pour montrer le cercle entier
        map.fitBounds(searchCircle.getBounds(), { padding: [20, 20] });

        // Mettre √† jour le hint
        mapHint.innerHTML = `<span class="location-detected">üìç Zone: ${rayonKm}km autour de la position</span>`;
    }

    // Fonction pour g√©ocoder une ville
    function geocodeVille(ville) {
        // Utiliser l'API geo.api.gouv.fr
        const query = encodeURIComponent(ville);
        fetch(`https://geo.api.gouv.fr/communes?nom=${query}&fields=nom,centre,codesPostaux&limit=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0 && data[0].centre) {
                    const commune = data[0];
                    const lat = commune.centre.coordinates[1];
                    const lon = commune.centre.coordinates[0];
                    const rayon = parseInt(rayonInput.value) || 10;
                    updateSearchCircle(lat, lon, rayon);
                } else {
                    // Essayer avec le code postal
                    fetch(`https://geo.api.gouv.fr/communes?codePostal=${query}&fields=nom,centre&limit=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0 && data[0].centre) {
                                const commune = data[0];
                                const lat = commune.centre.coordinates[1];
                                const lon = commune.centre.coordinates[0];
                                const rayon = parseInt(rayonInput.value) || 10;
                                updateSearchCircle(lat, lon, rayon);
                            }
                        })
                        .catch(() => {});
                }
            })
            .catch(() => {});
    }

    // G√©ocoder la ville initiale (Paris)
    geocodeVille('Paris');

    // √âcouter les changements de ville (avec debounce)
    let villeTimeout = null;
    villeInput.addEventListener('input', function() {
        clearTimeout(villeTimeout);
        villeTimeout = setTimeout(() => {
            if (villeInput.value.length >= 2) {
                geocodeVille(villeInput.value);
            }
        }, 500);
    });

    // √âcouter les changements de rayon
    rayonInput.addEventListener('input', function() {
        if (searchCircle) {
            const rayon = parseInt(rayonInput.value) || 10;
            const center = searchCircle.getLatLng();
            updateSearchCircle(center.lat, center.lng, rayon);
        }
    });

    if (geolocBtn) {
        geolocBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }

            // Animation de chargement
            geolocBtn.classList.add('loading');
            geolocBtn.textContent = '‚è≥';
            locationHint.textContent = 'Recherche de votre position...';

            navigator.geolocation.getCurrentPosition(
                // Succ√®s
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Remplir les champs cach√©s
                    latInput.value = lat.toFixed(6);
                    lonInput.value = lon.toFixed(6);

                    // Mettre √† jour la carte imm√©diatement
                    const rayon = parseInt(rayonInput.value) || 10;
                    updateSearchCircle(lat, lon, rayon);

                    // Reverse geocoding pour obtenir le nom de la ville
                    fetch(`https://geo.api.gouv.fr/communes?lat=${lat}&lon=${lon}&fields=nom,codesPostaux&limit=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const commune = data[0];
                                const cp = commune.codesPostaux ? commune.codesPostaux[0] : '';
                                villeInput.value = cp || commune.nom;
                                locationHint.innerHTML = `<span class="location-detected">üìç Position d√©tect√©e: ${commune.nom} (${cp})</span>`;
                            } else {
                                villeInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                                locationHint.innerHTML = `<span class="location-detected">üìç Coordonn√©es: ${lat.toFixed(4)}, ${lon.toFixed(4)}</span>`;
                            }

                            geolocBtn.classList.remove('loading');
                            geolocBtn.classList.add('success');
                            geolocBtn.textContent = '‚úì';

                            // Reset apr√®s 3 secondes
                            setTimeout(() => {
                                geolocBtn.classList.remove('success');
                                geolocBtn.textContent = 'üìç';
                            }, 3000);
                        })
                        .catch(err => {
                            // Fallback: utiliser les coordonn√©es directement
                            villeInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                            locationHint.innerHTML = `<span class="location-detected">üìç Coordonn√©es: ${lat.toFixed(4)}, ${lon.toFixed(4)}</span>`;

                            geolocBtn.classList.remove('loading');
                            geolocBtn.classList.add('success');
                            geolocBtn.textContent = '‚úì';
                        });
                },
                // Erreur
                function(error) {
                    geolocBtn.classList.remove('loading');
                    geolocBtn.textContent = 'üìç';

                    let message = 'Erreur de g√©olocalisation';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Acc√®s √† la position refus√©. Activez la g√©olocalisation dans votre navigateur.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Position non disponible';
                            break;
                        case error.TIMEOUT:
                            message = 'D√©lai d√©pass√©';
                            break;
                    }
                    locationHint.innerHTML = `<span style="color: var(--danger);">‚ö†Ô∏è ${message}</span>`;
                },
                // Options
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }

    // Clear les coordonn√©es si l'utilisateur tape manuellement
    if (villeInput) {
        villeInput.addEventListener('input', function() {
            latInput.value = '';
            lonInput.value = '';
        });
    }
});
</script>

{% if scraping_status.running %}
<script>
// Polling pour mettre √† jour le statut en temps r√©el
function updateStatus() {
    fetch('/scrape/status')
        .then(response => response.json())
        .then(data => {
            // Mettre √† jour le message
            document.getElementById('status-message').textContent = data.message || 'En cours...';

            // Mettre √† jour la barre de progression
            document.getElementById('progress-fill').style.width = data.progress + '%';
            document.getElementById('progress-text').textContent = data.progress + '%';

            // Changer l'ic√¥ne selon le statut
            if (data.running) {
                document.getElementById('status-icon').textContent = '‚è≥';
            } else {
                document.getElementById('status-icon').textContent = '‚úÖ';
                // Recharger la page quand termin√© pour afficher les r√©sultats
                setTimeout(() => window.location.reload(), 1000);
            }
        })
        .catch(err => console.error('Erreur polling:', err));
}

// Mettre √† jour toutes les 2 secondes
setInterval(updateStatus, 2000);

// Premier appel imm√©diat
updateStatus();
</script>
{% endif %}

{% endblock %}
